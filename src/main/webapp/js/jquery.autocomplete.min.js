(function(z){z.fn.extend({"AutoComplete":function(a){return this.each(function(){if(!(this&&this.tagName==="INPUT"&&this.type==="text")){return}if(this.controller){this.controller.setOption(a)}else{if(z.isPlainObject(a)){this.controller=new A(this,a)}}})}});var A=function(b,a){this.option=z.extend(false,{"width":320,"maxHeight":null,"itemHeight":null,"listStyle":"normal","listDirection":"down","data":[],"ajaxDataType":"json","ajaxParams":{},"ajaxTimeout":3000,"ajaxType":"GET","maxItems":20,"matchHandler":s,"emphasisHandler":t,"createItemHandler":null,"beforeLoadDataHandler":null,"afterSelectedHandler":null,"async":false,"emphasis":true,"onerror":null},a);E.apply(this,[b]);w.apply(this)};var E=function(b){var a=this;this.inputView=z(b);this.inputView.attr("autocomplete","off").keyup(this._keyup=function(c){switch(c.keyCode){case 13: $("#button").trigger("click");case 16:case 17:case 37:case 38:case 39:case 40:break;case 27:B.apply(a);break;default:if(a.option.async){setTimeout(function(){y.apply(a)},0)}else{y.apply(a)}}}).keydown(this._keydown=function(c){switch(c.keyCode){case 38:q.apply(a,["up"]);break;case 40:q.apply(a,["down"]);break;case 13:var d=a.searchView.is(":visible");D.apply(a);if(d){return false}break}}).blur(this._blur=function(){z(document).one("click",function(){B.apply(a)})})};var w=function(){var a=this;this.searchView=z("<div class='ac'><ul></ul></div>").appendTo(document.body).on("mouseenter","li",function(){a.searchView.find("li.selected").removeClass("selected");z(this).addClass("selected")}).on("mouseleave","li",function(){z(this).removeClass("selected")}).on("click","li",function(){D.apply(a);B.apply(a);$("#button").trigger("click");}).css("font-size",this.inputView.css("font-size"));z(window).resize(function(){v.apply(a)})};var x=function(c){var a=this,b=this.searchView.find("ul").empty();if(z.inArray(this.option.listStyle,["normal","iconList","custom"])==-1){throw ["遇到未知的listStyle参数！"]}z.each(c,function(f,d){var e=z("<li><div></div></li>").appendTo(b).addClass(a.option.listStyle).data("data",d).find("div");switch(a.option.listStyle){case"normal":e.append("<span>"+d.label+"</span>");break;case"iconList":var g=z("<img></img>").attr("src",d.image);e.append(z("<div></div>").append(g)).append("<span>"+d.label+"</span>");break;case"custom":e.append(a.option.createItemHandler.apply(a,[f,d]));case"default":break}if(a.option.itemHeight>0){e.height(a.option.itemHeight).css("max-height",a.option.itemHeight)}})};var v=function(){if(this.option.listDirection==="down"){var a=this.inputView.offset().top+this.inputView.outerHeight()}else{if(this.option.listDirection==="up"){var a=this.inputView.offset().top-this.searchView.outerHeight()}else{throw"遇到未知的listDirection参数！"}}var b=this.inputView.offset().left;this.searchView.css("top",a+"px").css("left",b+"px")};var C=function(){if(typeof(this.option.width)==="string"&&this.option.width.toLowerCase()==="auto"){return this.inputView.outerWidth()-2}else{if(typeof(this.option.width)==="number"){return this.option.width}else{throw"遇到未知的width参数！"}}};var u=function(c){var a=this;if(this.option.listDirection==="up"){c=c.reverse()}try{x.apply(a,[c]);if(this.option.maxHeight>0){this.searchView.css("max-height",this.option.maxHeight+"px");if(z.browser.msie){this.searchView.css("height",this.searchView.height()>this.option.maxHeight?this.option.maxHeight+"px":"auto")}}v.apply(this);this.searchView.css("width",C.apply(this)+"px")}catch(b){r.apply(this,[b+""]);return}this.searchView.show();q.apply(this,[this.option.listDirection])};var B=function(){this.searchView.find("ul").empty();this.searchView.hide()};var q=function(c){var b=this.searchView.find("li.selected");if(b.size()){var e=c==="up"?b.prev():b.next()}else{var e=c==="up"?this.searchView.find("li").last():this.searchView.find("li").first()}if(e.size()){this.searchView.find("li").removeClass("selected");e.addClass("selected");var a=e.outerHeight();var d=e.position().top;if(a+d>this.searchView.height()){this.searchView.scrollTop(this.searchView.scrollTop()+d+a-this.searchView.height())}else{if(d<0){this.searchView.scrollTop(this.searchView.scrollTop()+d)}}}};var D=function(){var c=this,d=this.searchView.find("li.selected");if(d.size()){var b=d.data("data");this.inputView.val(b.value);if(z.isFunction(this.option.afterSelectedHandler)){try{this.option.afterSelectedHandler.apply(c,[b])}catch(a){r.apply(this,["调用afterSelectedHandler错误:"+a]);return}}B.apply(this)}};var F=function(d){jQuery.support.cors=true;var b=this,a=[],c={"async":false,"dataType":b.option.ajaxDataType,"type":b.option.ajaxType,"timeout":this.option.ajaxTimeout,"success":function(g,e,f){if(b.option.ajaxDataType==="xml"){z(g).find("item").each(function(){var j={"value":z(this).text(),"label":z(this).text()};for(var k=0;k<this.attributes.length;k++){var i=this.attributes[k].nodeName,h=this.attributes[k].nodeValue;j[i]=h}a.push(j)})}else{if(b.option.ajaxDataType==="json"){a=g}else{throw"遇到未知的ajaxDataType参数！"}}},"error":function(g,e,f){throw f}};if(z.isPlainObject(this.option.ajaxParams)){c["data"]=z.extend(false,{"keyword":d},this.option.ajaxParams)}else{if(z.isFunction(this.option.ajaxParams)){c["data"]=z.extend(false,{"keyword":d},this.option.ajaxParams.apply(this,[d]))}else{if(typeof(this.option.ajaxParams)==="string"){c["data"]="keyword="+d+"&"+this.option.ajaxParams}else{throw"遇到未知的ajaxParams参数！"}}}z.ajax(this.option.data,c);return a};var y=function(){var c=this,d=this.inputView.val(),b=[],e=true,f=[];if(z.trim(d).length==0){B.apply(c);return}if(z.isFunction(this.option.beforeLoadDataHandler)){try{e=this.option.beforeLoadDataHandler.apply(this,[d])}catch(a){r.apply(this,["调用beforeLoadDataHandler错误:"+a]);return}}if(e){if(z.isArray(this.option.data)){b=this.option.data}else{if(z.isFunction(this.option.data)){try{b=this.option.data.apply(this,[d])}catch(a){r.apply(this,["调用data错误:"+a]);return}}else{if(typeof(this.option.data)==="string"){try{b=F.apply(this,[d])}catch(a){r.apply(this,["Ajax错误:"+a]);return}}else{r.apply(this,["遇到未知的data参数！"]);return}}}}z.each(b,function(h,i){if(c.option.maxItems>0&&f.length>=c.option.maxItems){return false}if(z.isPlainObject(i)){var g=z.extend(false,{},i)}else{if(typeof(i)==="string"){var g={"label":i,"value":i,"image":i}}else{r.apply(c,["数据源Item类型错误！"]);return false}}if(c.option.matchHandler.apply(c,[d,g])){f.push(g)}});if(d==this.inputView.val()){if(f.length>0){u.apply(this,[f])}else{B.apply(this)}}};var r=function(a){if(z.isFunction(this.option.onerror)){this.option.onerror.apply(this,[a])}};A.prototype.setOption=function(a){if(z.isPlainObject(a)){this.option=z.extend(false,this.option,a)}else{if(typeof(a)==="string"){switch(a){case"destroy":this.destroy();break;case"show":this.show();break;default:r.apply(this,["未知的AutoComplete参数！"]);return}}else{r.apply(this,["未知的AutoComplete参数类型！"]);return}}};A.prototype.destroy=function(){this.searchView.remove();this.inputView.unbind("keyup",this._keyup).unbind("keydown",this._keydown).unbind("blur",this._blur);delete this.inputView.get(0).controller};A.prototype.show=function(){if(this.option.async){setTimeout(function(){y.apply(this)},0)}else{y.apply(this)}};var s=function(c,a){var b=RegExp(c.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1"),"i");if(this.option.emphasis&&z.isFunction(this.option.emphasisHandler)){this.option.emphasisHandler.apply(this,[c,a])}return b.test(a.value)};var t=function(c,a){var b=RegExp("("+c.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")+")","ig");a.label=a.label.replace(b,"<em>$1</em>")}})(jQuery);